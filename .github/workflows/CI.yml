name: CI

on:
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Hello World
        run: echo Hello World!!

      - name: create local container
        run: docker-compose -f docker-compose.test.yml up -d --build

      - name: setup env
        run: |
          ./ci/setup.sh

      - name: test app
        run: |
          ./ci/test.sh

  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Hello World
        run: echo Hello World!!

      - name: build container
        run: |
          docker-compose build
        env:
          DOCKER_TLS_VERIFY: "1"
          DOCKER_HOST: "tcp://54.91.12.208:2376"
          DOCKER_CERT_PATH: "certs"
          DOCKER_MACHINE_NAME: "cursodevops"


      - name: deploy container
        run: |
          docker-compose down
          docker system prune -f
          docker-compose up -d
        env:
          DOCKER_TLS_VERIFY: "1"
          DOCKER_HOST: "tcp://54.91.12.208:2376"
          DOCKER_CERT_PATH: "certs"
          DOCKER_MACHINE_NAME: "cursodevops"